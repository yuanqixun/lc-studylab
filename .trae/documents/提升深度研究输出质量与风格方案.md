## 现状与问题
- `res.md` 的输出呈现明显模板化，缺少深入分析与示例；可溯源为 DeepResearch 的笔记/报告模板与回退写法。
- 产生模板化位置：
  - 网研笔记格式硬编码（deep_research/deep_agent.py:363–385），要求固定“搜索策略/主要发现/参考来源”。
  - 报告大纲硬编码（deep_research/deep_agent.py:548–579）与综合回退写法（deep_research/deep_agent.py:648–755），内容组织过于僵化。
  - 子智能体提示词同样使用固定结构（deep_research/subagents.py:37–82, 139–202）。
- 对比 `chatgpt.md`，其内容更自然：以概念→动机→用法→示例→最佳实践→注意事项的节奏展开，无多余模板痕迹。

## 目标
- 输出自然、深入、结构化但不过度模板化；能根据问题类型动态决定结构。
- 增强证据与引用质量；在技术主题中加入真实代码示例与常见陷阱。
- 在流式体验中按“章节/段落”输出，减少机械化占位文字。

## 技术改造
- 重写提示词与风格准则（集中管理）：
  - 在 `backend/core/prompts.py` 增加“Writer Guidelines”片段：
    - 组织策略：概念→动机→核心 API/用法→示例→最佳实践→陷阱→对比/FAQ（按主题动态裁剪）。
    - 风格约束：避免模板语；强调信息整合、洞察与实证；必要时提供代码示例与依赖数组/生命周期等细节。
  - 在 `deep_research/deep_agent.py` 的网研与写作节点替换硬模板：
    - 网研节点（deep_research/deep_agent.py:349–389）改为“建议性结构 + 允许自由组织”，根据来源类型自适配展示方式（论文/标准/官方文档/博客）。
    - 报告节点（deep_research/deep_agent.py:537–581）改为“主题驱动大纲”，允许模型根据材料密度与用户场景选择合适章节；删除回退文本的模板化措辞，改用综合性叙述与内联引用。
  - 同步更新子智能体提示词（deep_research/subagents.py:37–82, 139–202）为“风格准则 + 动态结构”，降低固定评分星级、固定表格的强约束。
- 引用与证据改进：
  - 在网研与报告写作中强制使用“内联引用 + 参考列表”；
  - 对技术主题要求“至少一个可运行示例或伪代码”；
  - 对比类问题引入对照表但避免模板化标题。
- 质量护栏与自审：
  - 利用现有 Guardrails（core/guardrails/output_validators.py）添加质量基线检查：最小长度、是否含示例（技术类）、是否有引用；未达标时触发自我修订（一个复查小节点）。
  - 自我修订 Rubric：清晰性、信息密度、示例与可操作性、引用完整性；不引入思维链泄露，仅做显式“修订指令”。
- 流式输出体验：
  - 将写作节点按“section 开始/结束”分片推送，前端以章节块显示；避免推送模板占位语。
  - 更新聊天流端点的事件类型中添加“section”标记（不改协议仅加字段），便于 UI 按章节渲染。

## 实施步骤
1. 在 `core/prompts.py` 增加 Writer Guidelines 片段与获取函数；将 `agents/base_agent.py` 保持使用该中心化提示词。
2. 调整 `deep_research/deep_agent.py`：
   - 网研指令重写（363–385）：改为建议性结构，强调来源类型自适配与内联引用。
   - 报告指令重写（548–579）：移除硬编码大纲，按主题驱动生成；增强示例与引用要求。
   - 回退综合写作（648–755）：去模板措辞，改为信息综合与洞察表达；保留时间与 thread_id 元数据但弱化陈述语。
3. 更新 `deep_research/subagents.py` 三个提示词段落，统一接入 Writer Guidelines。
4. 在 `core/guardrails/output_validators.py` 增加质量基线检查项；在报告节点末尾引入一次“修订调用”。
5. 在后端聊天流端点增加“section”标记字段；前端解析器按段落渲染。
6. 在 `backend/docs/stage_04` 与 `stage_05` 文档中记录变更与新的最佳实践（遵循 .cursor/rules）。

## 验收标准
- 针对“介绍一下 React Hooks”生成的 `final_report.md` 接近 `chatgpt.md` 的质量：
  - 结构自然，包含代码示例、最佳实践、陷阱与对比；
  - 引用 3+ 权威来源并内联标注；
  - 无模板化占位语或冗余的生成时间通用段落；
  - 流式输出按章节块逐步呈现。

## 风险与回滚
- 保留原有回退路径以保证可用性；如新提示词产生异常质量波动，可快速切换回旧提示词配置（环境开关）。
