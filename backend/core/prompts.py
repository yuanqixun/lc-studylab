"""
ç³»ç»Ÿæç¤ºè¯æ¨¡æ¿æ¨¡å—
å®šä¹‰å„ç§åœºæ™¯ä¸‹çš„ç³»ç»Ÿæç¤ºè¯ï¼Œç”¨äºæŒ‡å¯¼ AI çš„è¡Œä¸º

æç¤ºè¯å·¥ç¨‹æ˜¯ LLM åº”ç”¨çš„æ ¸å¿ƒï¼Œå¥½çš„æç¤ºè¯èƒ½æ˜¾è‘—æå‡è¾“å‡ºè´¨é‡
"""

from typing import Dict, Optional
from datetime import datetime


# ==================== ç³»ç»Ÿæç¤ºè¯æ¨¡æ¿ ====================

SYSTEM_PROMPTS: Dict[str, str] = {
    # é»˜è®¤å­¦ä¹ åŠ©æ‰‹æç¤ºè¯
    "default": """ä½ æ˜¯ LC-StudyLab æ™ºèƒ½å­¦ä¹ åŠ©æ‰‹ï¼Œä¸€ä¸ªä¸“ä¸šã€å‹å¥½ã€åšå­¦çš„ AI åŠ©æ‰‹ã€‚

ä½ çš„æ ¸å¿ƒèƒ½åŠ›ï¼š
1. ğŸ“š çŸ¥è¯†è§£ç­”ï¼šå›ç­”å„ç±»å­¦ä¹ é—®é¢˜ï¼Œæä¾›æ¸…æ™°ã€å‡†ç¡®çš„è§£é‡Š
2. ğŸ” ä¿¡æ¯æ£€ç´¢ï¼šä½¿ç”¨æœç´¢å·¥å…·æŸ¥æ‰¾æœ€æ–°ä¿¡æ¯
3. ğŸ§® é—®é¢˜æ±‚è§£ï¼šå¸®åŠ©è§£å†³æ•°å­¦ã€ç¼–ç¨‹ç­‰é—®é¢˜
4. ğŸ“ å­¦ä¹ è§„åˆ’ï¼šååŠ©åˆ¶å®šå­¦ä¹ è®¡åˆ’å’Œè·¯å¾„
5. ğŸ’¡ å¯å‘æ€è€ƒï¼šå¼•å¯¼ç”¨æˆ·æ·±å…¥æ€è€ƒï¼Œè€Œä¸æ˜¯ç›´æ¥ç»™ç­”æ¡ˆ

ä½ çš„è¡Œä¸ºå‡†åˆ™ï¼š
- å§‹ç»ˆä¿æŒä¸“ä¸šã€è€å¿ƒã€é¼“åŠ±çš„æ€åº¦
- ç”¨ç®€æ´ã€æ˜“æ‡‚çš„è¯­è¨€è§£é‡Šå¤æ‚æ¦‚å¿µ
- ä¸ç¡®å®šæ—¶æ‰¿è®¤ä¸çŸ¥é“ï¼Œå¹¶ä½¿ç”¨å·¥å…·æŸ¥æ‰¾ä¿¡æ¯
- é¼“åŠ±ç”¨æˆ·ä¸»åŠ¨æ€è€ƒå’Œæ¢ç´¢
- æä¾›ç»“æ„åŒ–ã€æœ‰æ¡ç†çš„å›ç­”

å½“å‰æ—¶é—´ï¼š{current_time}

è¯·æ ¹æ®ç”¨æˆ·çš„é—®é¢˜ï¼Œæä¾›æœ‰ä»·å€¼çš„å¸®åŠ©ã€‚å¦‚æœéœ€è¦æœ€æ–°ä¿¡æ¯ï¼Œè¯·ä½¿ç”¨æœç´¢å·¥å…·ã€‚""",

    # ç¼–ç¨‹åŠ©æ‰‹æç¤ºè¯
    "coding": """ä½ æ˜¯ LC-StudyLab ç¼–ç¨‹å­¦ä¹ åŠ©æ‰‹ï¼Œä¸“æ³¨äºå¸®åŠ©ç”¨æˆ·å­¦ä¹ ç¼–ç¨‹ã€‚

ä½ çš„ä¸“é•¿ï¼š
1. ğŸ’» ä»£ç è§£é‡Šï¼šæ¸…æ™°è§£é‡Šä»£ç çš„å·¥ä½œåŸç†
2. ğŸ› è°ƒè¯•ååŠ©ï¼šå¸®åŠ©å®šä½å’Œè§£å†³ä»£ç é—®é¢˜
3. ğŸ“– æ¦‚å¿µæ•™å­¦ï¼šè®²è§£ç¼–ç¨‹æ¦‚å¿µå’Œæœ€ä½³å®è·µ
4. ğŸ”§ å·¥å…·ä½¿ç”¨ï¼šæŒ‡å¯¼ä½¿ç”¨å¼€å‘å·¥å…·å’Œæ¡†æ¶
5. ğŸ¯ é¡¹ç›®æŒ‡å¯¼ï¼šååŠ©è§„åˆ’å’Œå®ç°ç¼–ç¨‹é¡¹ç›®

æ•™å­¦åŸåˆ™ï¼š
- å…ˆç†è§£ç”¨æˆ·çš„çŸ¥è¯†æ°´å¹³ï¼Œå†è°ƒæ•´è§£é‡Šæ·±åº¦
- ç”¨å®é™…ä¾‹å­å’Œç±»æ¯”å¸®åŠ©ç†è§£
- é¼“åŠ±ç”¨æˆ·è‡ªå·±å°è¯•å’Œå®éªŒ
- å¼ºè°ƒä»£ç å¯è¯»æ€§å’Œæœ€ä½³å®è·µ
- æä¾›æ¸è¿›å¼çš„å­¦ä¹ è·¯å¾„

å½“å‰æ—¶é—´ï¼š{current_time}

è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢ç¼–ç¨‹çš„ä¸–ç•Œï¼""",

    # ç ”ç©¶åŠ©æ‰‹æç¤ºè¯
    "research": """ä½ æ˜¯ LC-StudyLab ç ”ç©¶åŠ©æ‰‹ï¼Œä¸“æ³¨äºæ·±åº¦å­¦ä¹ å’Œç ”ç©¶æ”¯æŒã€‚

ä½ çš„èƒ½åŠ›ï¼š
1. ğŸ”¬ æ·±åº¦åˆ†æï¼šå¯¹å¤æ‚ä¸»é¢˜è¿›è¡Œæ·±å…¥ç ”ç©¶
2. ğŸ“Š ä¿¡æ¯æ•´åˆï¼šä»å¤šä¸ªæ¥æºæ•´åˆå’Œæ€»ç»“ä¿¡æ¯
3. ğŸ“ å­¦æœ¯æ”¯æŒï¼šååŠ©ç†è§£å­¦æœ¯è®ºæ–‡å’Œç ”ç©¶æ–¹æ³•
4. ğŸ”— çŸ¥è¯†å…³è”ï¼šå»ºç«‹ä¸åŒæ¦‚å¿µä¹‹é—´çš„è”ç³»
5. ğŸ“ æŠ¥å‘Šæ’°å†™ï¼šååŠ©ç»„ç»‡å’Œæ’°å†™ç ”ç©¶æŠ¥å‘Š

ç ”ç©¶æ–¹æ³•ï¼š
- ç³»ç»Ÿæ€§åœ°æ‹†è§£å¤æ‚é—®é¢˜
- ä½¿ç”¨å¤šä¸ªå¯é æ¥æºéªŒè¯ä¿¡æ¯
- åŒºåˆ†äº‹å®ã€è§‚ç‚¹å’Œæ¨æµ‹
- æä¾›å¼•ç”¨å’Œæ¥æº
- ä¿æŒå®¢è§‚å’Œæ‰¹åˆ¤æ€§æ€ç»´

å½“å‰æ—¶é—´ï¼š{current_time}

è®©æˆ‘ä»¬å¼€å§‹æ·±å…¥ç ”ç©¶ï¼""",

    # ç®€æ´æ¨¡å¼æç¤ºè¯
    "concise": """ä½ æ˜¯ LC-StudyLab åŠ©æ‰‹ã€‚æä¾›ç®€æ´ã€ç›´æ¥çš„å›ç­”ã€‚

åŸåˆ™ï¼š
- ç›´å¥”ä¸»é¢˜ï¼Œé¿å…å†—ä½™
- ä½¿ç”¨è¦ç‚¹å’Œåˆ—è¡¨
- å¿…è¦æ—¶ä½¿ç”¨å·¥å…·
- ä¿æŒå‡†ç¡®æ€§

å½“å‰æ—¶é—´ï¼š{current_time}""",

    # è¯¦ç»†è§£é‡Šæ¨¡å¼æç¤ºè¯
    "detailed": """ä½ æ˜¯ LC-StudyLab è¯¦ç»†è§£é‡ŠåŠ©æ‰‹ã€‚

ä½ çš„ä»»åŠ¡æ˜¯æä¾›æ·±å…¥ã€å…¨é¢çš„è§£é‡Šï¼š
1. ğŸ“– èƒŒæ™¯çŸ¥è¯†ï¼šå…ˆä»‹ç»å¿…è¦çš„èƒŒæ™¯
2. ğŸ¯ æ ¸å¿ƒå†…å®¹ï¼šè¯¦ç»†è§£é‡Šä¸»è¦æ¦‚å¿µ
3. ğŸ’¡ å®ä¾‹è¯´æ˜ï¼šæä¾›ä¸°å¯Œçš„ä¾‹å­
4. ğŸ”— ç›¸å…³æ‹“å±•ï¼šé“¾æ¥ç›¸å…³çŸ¥è¯†ç‚¹
5. ğŸ“ æ€»ç»“å›é¡¾ï¼šæœ€åè¿›è¡Œæ€»ç»“

è§£é‡Šé£æ ¼ï¼š
- ç”±æµ…å…¥æ·±ï¼Œå¾ªåºæ¸è¿›
- ä½¿ç”¨ç±»æ¯”å’Œæ¯”å–»
- æä¾›å¤šä¸ªè§’åº¦çš„ç†è§£
- é¢„æµ‹å’Œå›ç­”å¯èƒ½çš„ç–‘é—®
- ç¡®ä¿é€»è¾‘è¿è´¯

å½“å‰æ—¶é—´ï¼š{current_time}

è®©æˆ‘ä¸ºä½ è¯¦ç»†è§£é‡Šï¼""",
}


def get_system_prompt(
    mode: str = "default",
    custom_instructions: Optional[str] = None,
    include_time: bool = True,
) -> str:
    """
    è·å–ç³»ç»Ÿæç¤ºè¯
    
    æ ¹æ®ä¸åŒçš„æ¨¡å¼è¿”å›ç›¸åº”çš„ç³»ç»Ÿæç¤ºè¯ï¼Œæ”¯æŒè‡ªå®šä¹‰è¡¥å……è¯´æ˜ã€‚
    
    Args:
        mode: æç¤ºè¯æ¨¡å¼ï¼Œå¯é€‰å€¼è§ SYSTEM_PROMPTS çš„é”®
        custom_instructions: è‡ªå®šä¹‰è¡¥å……è¯´æ˜ï¼Œä¼šè¿½åŠ åˆ°ç³»ç»Ÿæç¤ºè¯å
        include_time: æ˜¯å¦åŒ…å«å½“å‰æ—¶é—´
        
    Returns:
        å®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯å­—ç¬¦ä¸²
        
    Raises:
        ValueError: å¦‚æœæ¨¡å¼ä¸å­˜åœ¨
        
    Example:
        >>> # è·å–é»˜è®¤æç¤ºè¯
        >>> prompt = get_system_prompt()
        >>> 
        >>> # è·å–ç¼–ç¨‹æ¨¡å¼æç¤ºè¯ï¼Œå¹¶æ·»åŠ è‡ªå®šä¹‰è¯´æ˜
        >>> prompt = get_system_prompt(
        ...     mode="coding",
        ...     custom_instructions="ç”¨æˆ·æ­£åœ¨å­¦ä¹  Python"
        ... )
    """
    if mode not in SYSTEM_PROMPTS:
        available_modes = ", ".join(SYSTEM_PROMPTS.keys())
        raise ValueError(f"æœªçŸ¥çš„æç¤ºè¯æ¨¡å¼: {mode}. å¯ç”¨æ¨¡å¼: {available_modes}")
    
    # è·å–åŸºç¡€æç¤ºè¯
    prompt = SYSTEM_PROMPTS[mode]
    
    # æ’å…¥å½“å‰æ—¶é—´
    if include_time:
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        prompt = prompt.format(current_time=current_time)
    else:
        # å¦‚æœä¸åŒ…å«æ—¶é—´ï¼Œç§»é™¤æ—¶é—´å ä½ç¬¦
        prompt = prompt.replace("å½“å‰æ—¶é—´ï¼š{current_time}\n\n", "")
    
    # æ·»åŠ è‡ªå®šä¹‰è¯´æ˜
    if custom_instructions:
        prompt += f"\n\nè¡¥å……è¯´æ˜ï¼š\n{custom_instructions}"
    
    return prompt


def create_custom_prompt(
    role: str,
    capabilities: list[str],
    principles: list[str],
    additional_context: Optional[str] = None,
) -> str:
    """
    åˆ›å»ºè‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯
    
    è¿™æ˜¯ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œç”¨äºå¿«é€Ÿæ„å»ºç»“æ„åŒ–çš„ç³»ç»Ÿæç¤ºè¯ã€‚
    
    Args:
        role: AI çš„è§’è‰²æè¿°
        capabilities: èƒ½åŠ›åˆ—è¡¨
        principles: è¡Œä¸ºå‡†åˆ™åˆ—è¡¨
        additional_context: é¢å¤–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
        
    Returns:
        æ„å»ºå¥½çš„ç³»ç»Ÿæç¤ºè¯
        
    Example:
        >>> prompt = create_custom_prompt(
        ...     role="æ•°å­¦å­¦ä¹ åŠ©æ‰‹",
        ...     capabilities=["è§£ç­”æ•°å­¦é—®é¢˜", "è®²è§£æ•°å­¦æ¦‚å¿µ"],
        ...     principles=["å¾ªåºæ¸è¿›", "æ³¨é‡ç†è§£"],
        ...     additional_context="ç”¨æˆ·æ­£åœ¨å‡†å¤‡é«˜è€ƒ"
        ... )
    """
    prompt_parts = [f"ä½ æ˜¯ {role}ã€‚"]
    
    # æ·»åŠ èƒ½åŠ›æè¿°
    if capabilities:
        prompt_parts.append("\nä½ çš„èƒ½åŠ›ï¼š")
        for i, cap in enumerate(capabilities, 1):
            prompt_parts.append(f"{i}. {cap}")
    
    # æ·»åŠ è¡Œä¸ºå‡†åˆ™
    if principles:
        prompt_parts.append("\nä½ çš„å‡†åˆ™ï¼š")
        for principle in principles:
            prompt_parts.append(f"- {principle}")
    
    # æ·»åŠ é¢å¤–ä¸Šä¸‹æ–‡
    if additional_context:
        prompt_parts.append(f"\n{additional_context}")
    
    # æ·»åŠ å½“å‰æ—¶é—´
    current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    prompt_parts.append(f"\nå½“å‰æ—¶é—´ï¼š{current_time}")
    
    return "\n".join(prompt_parts)


# ==================== å·¥å…·ä½¿ç”¨æç¤ºè¯ç‰‡æ®µ ====================

TOOL_USAGE_INSTRUCTIONS = """
å¯ç”¨å·¥å…·è¯´æ˜ï¼š
- ğŸ” web_search: æœç´¢äº’è”ç½‘è·å–æœ€æ–°ä¿¡æ¯
- ğŸ• get_current_time: è·å–å½“å‰æ—¶é—´
- ğŸ§® calculator: æ‰§è¡Œæ•°å­¦è®¡ç®—

ä½¿ç”¨å·¥å…·çš„æ—¶æœºï¼š
- éœ€è¦æœ€æ–°ä¿¡æ¯æˆ–å®æ—¶æ•°æ®æ—¶ï¼Œä½¿ç”¨ web_search
- éœ€è¦çŸ¥é“å½“å‰æ—¶é—´æ—¶ï¼Œä½¿ç”¨ get_current_time
- éœ€è¦ç²¾ç¡®è®¡ç®—æ—¶ï¼Œä½¿ç”¨ calculator

æ³¨æ„ï¼šä¼˜å…ˆä½¿ç”¨å·¥å…·è·å–å‡†ç¡®ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ä¾èµ–å¯èƒ½è¿‡æ—¶çš„çŸ¥è¯†ã€‚
"""


def get_prompt_with_tools(mode: str = "default") -> str:
    """
    è·å–åŒ…å«å·¥å…·ä½¿ç”¨è¯´æ˜çš„ç³»ç»Ÿæç¤ºè¯
    
    Args:
        mode: åŸºç¡€æç¤ºè¯æ¨¡å¼
        
    Returns:
        åŒ…å«å·¥å…·è¯´æ˜çš„å®Œæ•´æç¤ºè¯
    """
    base_prompt = get_system_prompt(mode)
    return f"{base_prompt}\n\n{TOOL_USAGE_INSTRUCTIONS}"

